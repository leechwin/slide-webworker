<!doctype html>
<html>
    <head>
        <meta charset="utf-8">

        <title>Concurrency Programming of WebApp</title>

        <meta name="description" content="Web Worker">
        <meta name="author" content="leechwin1@gmail.com">

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="css/reveal.min.css">
        <link rel="stylesheet" href="css/theme/solarized.css" id="theme">

        <!-- For syntax highlighting -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <link rel="stylesheet" href="css/style.css">

        <!-- If the query includes 'print-pdf', use the PDF print sheet -->
        <script>
            document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
        </script>

        <script src="js/jquery-2.1.0.min.js"></script>
        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->

        <script src="http://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    </head>

    <body>
        <div class="reveal">
            <!-- Any section element inside of this container is displayed as a slide -->
            <div class="slides">

                <section>
                    <h2>Concurrency Programming of Web</h2>
                    <br>
                    <div>
                        <a href="mailto:leechwin1@gmail.com">changhyun1.lee@samsung.com</a>
                    </div>
                    <br>
                    <div>2014. 11</div>
                </section>

                <section>
                    <h2>Overview</h2>
                    <br>
                    <ul>
                        <li><span class='myspan'>Concurrency Programming</span>
                        <li><span class='myspan'>Concurrency Programming of Web</span>
                        <li><span class='myspan'>JavaScript Concurrency Model</span>
                        <li><span class='myspan'>Web Worker</span>
                    </ul>
                </section>

                <section>
                    <section>
                        <h2>Concurrency Programming</h2>
                    </section>
                    <section>
                        <h2>Concurrency Programming</h2>
                        <br>
                        <ul>
                            <li><span class='myspan'>Concurrency is the notion of multiple things happening at the same time</span>
                        </ul>
                        <img src="images/thread.png">
                    </section>
                    <section>
                        <h2>Models for Programming Concurrency</h2>
                        <br>
                        <ul>
                            <li><span class='myspan'>Sequential Programming</span>
                            <li><span class='myspan'>Message-passing Concurrency</span>
                            <li><span class='myspan'>Shared-state Concurrency</span>
                                <ul><li>Mutexes, Semaphores, or Monitors</li></ul>
                        </ul>
                    </section>
                    <section>
                        <h2>Concurrency in Java</h2>
                        <br>
                        <ul>
                            <li><span class='myspan'>Processes</span>
                            <li><span class='myspan'>Threads</span>
                            <li><span class='myspan'>Locks and thread synchronization</span>
                        </ul>
                        <img src="images/javaThread.png">
                    </section>
                    <section>
                        <h2>How about the Web?</h2>
                        <br>
                        <img src="images/web.png">
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Concurrency Programming of Web</h2>
                        <br>
                        <ul>
                            <li><span class='myspan'>Server Side</span>
                            <li><span class='myspan'>Client Side</span>
                        </ul>
                    </section>
                    <section>
                        <h2>Server Side</h2>
                        <br>
                        <ul>
                            <li><span class='myspan'>Powerful Framework</span>
                                <ul><li>Spring, Node.js, Etc</li></ul>
                            <li><span class='myspan'>Use kind of operating system for development</span>
                                <ul><li><span class='myspan'>Support for multi-core and multi-threading</span>
                                    <ul>
                                        <li>Java</li>
                                        <li>JavaScript (Node.js cluster, multiplexing)</li>
                                    </ul>
                                </ul>
                        </ul>
                    </section>
                    <section>
                        <h2>Client Side (WebApp)</h2>
                        <br>
                        <ul>
                            <li><span class='myspan-red'>In the Browser</span>
                            <li><span class='myspan'>Use kind of browser interface for development</span>
                                <ul><li><span class='myspan'><strike>Support for multi-core and multi-threading</strike></span>
                                    <ul>
                                        <li><span class='myspan-red'>Single Thread</span> concept of JavaScript running in browser</li>
                                    </ul>
                                </ul>
                        </ul>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>JavaScript Concurrency Model</h2>
                    </section>
                    <section>
                        <h2>UI Thread in Browser</h2>
                        <br>
                        <ul>
                            <li><span class='myspan-red'>Single Thread</span><span> Event Loop/Queue Mechanism</span>
                            <li><span class='myspan'>UI Thread is responsible for both <span class='myspan-red'>UI Updates</span> and <span class='myspan-red'>JavaScrtipt Execution</span></span>
                        </ul>
                        <img src="images/eventloop.png">
                    </section>
                    <section data-transition="none">
                        <h2>When Button Click Event</h2>
                        <br>
                        <img src="images/btnNor.png">
                        <br>
                        <img src="images/ui1.png">
                    </section>
                    <section data-transition="none">
                        <h2>When Button Click Event</h2>
                        <br>
                        <img src="images/btnNor.png">
                        <br>
                        <img src="images/ui2.png">
                    </section>
                    <section data-transition="none">
                        <h2>When Button Click Event</h2>
                        <br>
                        <img src="images/btnPush.png">
                        <br>
                        <img src="images/ui3.png">
                    </section>
                    <section data-transition="none">
                        <h2>When Button Click Event</h2>
                        <br>
                        <img src="images/btnPush.png">
                        <br>
                        <img src="images/ui4.png">
                    </section>
                    <section data-transition="none">
                        <h2>When Button Click Event</h2>
                        <br>
                        <img src="images/btnNor.png">
                        <br>
                        <img src="images/ui5.png">
                    </section>
                    <section data-transition="none">
                        <h2>When Button Click Event</h2>
                        <br>
                        <img src="images/ui6.png">
                    </section>
                    <section>
                        <h2><p>UI pending while JavaScript is executing</p></h2>
                        <h2><p class="fragment current-visible"><span class='myspan-red'>UI long pending</span> while <span class='myspan-red'>Heavy Weight JavaScript</span> is executing</p></h2>
                    </section>
                    <section>
                        <h2 style="color: red;">Unresponsive UI</h2>
                        <img src="images/IEError.png">
                        <img src="images/SafariError.png">
                        <img src="images/ChromeError.png">
                        <img src="images/FireFoxError.png">
                    </section>
                    <section>
                        <h2>Runaway Script Timer Limits</h2>
                        <br>
                        <ul>
                            <li><span class='myspan'><a href="http://support.microsoft.com/kb/175500">IE: 5 million statements</a></span>
                            <li><span class='myspan'>Chrome: Unknown, Self crash control</span>
                            <li><span class='myspan'><a href="http://kb.mozillazine.org/Dom.max_script_run_time">Firefox: 10 seconds</a></span>
                            <li><span class='myspan'><a href="http://trac.webkit.org/changeset/14904#file4">Safari: 5 seconds</a></span>
                        </ul>
                    </section>
                    <section>
                        <h2>Imitate Multi-Thread Programming</h2>
                        <br>
                        <ul>
                            <li><span class='myspan'>JavaScript Timers</span>
                                <ul>
                                    <li>var id = setTimeout( fn, delay );</li>
                                    <li>var id = setInterval( fn, delay );</li>
                                    <li>clearTimeout( id );</li>
                                    <li>clearInterval( id );</li>
                                </ul>
                        </ul>
                    </section>
                    <section>
                        <h2>Timer delay is not guaranteed</h2>
                        <br>
                        <pre><code data-trim>
function fun1() {
    console.log("fun1");
    setTimeout(fun2, 0);
    console.log("fun1-2");
    fun3();
}
function fun2() {
    console.log("fun2");
}
function fun3() {
    console.log("fun3");
}
fun1();
                        </code></pre>
                        <span class='myspan'>Expect Result: fun1, fun2, fun1-2, fun3 ?</span>
                        <br>
                        <div id="timerDiv"></div>
                        <button onclick="timerBtn()">Demo</button>
                    </section>
                    <section>
                        <h2>Timer delay is not guaranteed</h2>
                        <br>
                        <img src="images/timers.png">
                    </section>
                    <section>
                        <h2>Multithreaded Programming to JavaScript is Impossible?</h2>
                        <h2><p class="fragment current-visible"><span class='myspan-red'>Possible to WebWorker.</span></p></h2>
                        <br>
                    </section>
                </section>

                <section>
                    <section>
                        <img src="images/webworker.png">
                    </section>
                    <section>
                        <h2>Web Worker</h2>
                        <br>
                        <ul>
                            <li><span class='myspan'>A web worker is a <span class='myspan-red'>JavaScript running in the background,</span> without affecting the performance of the page.</span>
                            <li><span class='myspan'>Javascript executed on a separate thread ( background and not the UI thread)</span>
                        </ul>
                        <img src="images/webworkerHistory.png">
                    </section>
                    <section>
                        <h2>Web Worker</h2>
                        <br>
                        <img src="images/webwokerThread.png">
                    </section>
                    <section>
                        <h2>Web Worker Demo</h2>
                        <br>
                        <!-- Reference: http://slides.html5rocks.com/#web-workers -->
                        <div id="w-wrapper">
                            <div id="wmap" class="gmap example">
                                <img src="http://maps.google.com/maps/api/staticmap?center=13,13&zoom=3&size=680x200&sensor=false"/>
                            </div>
                            <div style="margin-top:5px">
                                <button id="find-route-n">Find route without Workers</button>
                                <button id="find-route-y">Find route with Workers</button>
                                <p id="w-loading">Loading Route...</p>
                            </div>
                        </div>
                        <script src="js/worker/points.js" defer></script>
                        <script src="js/worker/annealing.js" defer></script>
                        <script defer>
                            (function() {
                                var markersArray = [];
                                var map = null;
                                var useThreads = false;

                                document.querySelector('#w-wrapper').addEventListener('click', function(event) {
                                    if (!map) {
                                        map = new google.maps.Map(document.querySelector('#wmap'), {
                                            zoom: 3,
                                            center: new google.maps.LatLng(13, 13),
                                            mapTypeId: google.maps.MapTypeId.ROADMAP
                                        });
                                        map.getDiv().style.border =  '1px solid #ccc';
                                        drawPoints();
                                    }

                                    if (event.target.id == 'find-route-y') {
                                        useThreads = true;
                                        document.querySelector('#w-loading').style.visibility = 'visible';
                                        test();
                                    } else if (event.target.id == 'find-route-n'){
                                        useThreads = false;
                                        document.querySelector('#w-loading').style.visibility = 'visible';
                                        // this setTimout is so that we see the 'loading' label
                                        setTimeout(function() { test(); }, 10);
                                    }
                                }, false);

                                function drawPath(path) {
                                    var firstPoint = true;
                                    var l = p1.length;
                                    var scaleFactor = 5;
                                    for (var i = 0; i < l - 1; ++i) {
                                        var points = [
                                            new google.maps.LatLng(p1[i].x / scaleFactor,
                                                    p1[i].y / scaleFactor),
                                            new google.maps.LatLng(p1[i + 1].x / scaleFactor,
                                                    p1[i + 1].y / scaleFactor)
                                        ];
                                        var polyline = new google.maps.Polyline(
                                                {path: points, strokeColor: '#ff0000', strokeWeight: 1});
                                        markersArray.push(polyline);
                                        polyline.setMap(map);
                                    }
                                }

                                function drawPoints() {
                                    var blueIcon = new google.maps.MarkerImage(
                                            'images/point.png',
                                            new google.maps.Size(3, 3), // size
                                            new google.maps.Point(0, 0), // origin
                                            new google.maps.Point(0, 0)); // anchor
                                    for (var i = 0; i < p1.length; ++i) {
                                        // Render in Gmap instead of canvas
                                        var point = new google.maps.LatLng(p1[i].x / 5, p1[i].y / 5);
                                        var marker = new google.maps.Marker({
                                            position: point, icon: blueIcon, map: map});
                                        markersArray.push(marker);
                                    }
                                }

                                function deleteOverlays() {
                                    if (markersArray) {
                                        for (var i in markersArray) {
                                            markersArray[i].setMap(null);
                                        }
                                        markersArray = [];
                                    }
                                }

                                function test() {
                                    var name = "Test 1";
                                    var self = this;
                                    deleteOverlays();
                                    drawPoints();
                                    setTimeout(function() {
                                        var opts = {
                                            points: p1,
                                            t0: 1,
                                            g: 0.99,
                                            stepsPerT: 10
                                        };
                                        var callback = {
                                            name: name,
                                            newMin: function(p) {
                                            },
                                            draw: function(p) {
                                                document.querySelector('#w-loading').style.visibility = 'hidden';
                                                drawPath(p);
                                            }
                                        };
                                        var a;
                                        if (useThreads) {
                                            var worker = new Worker('js/worker/workerMap.js')
                                            worker.onmessage = function(event) {
                                                var returnedData = JSON.parse(event.data);
                                                var msg = returnedData[0];
                                                var p = returnedData[1];
                                                callback[msg](p);
                                            };
                                            worker.onerror = function(event) {
                                                console.log(event);
                                            };
                                            worker.postMessage(JSON.stringify({
                                                opts: opts,
                                                width: 200,
                                                height: 200
                                            }));
                                        } else {
                                            var annealing = new Annealing();
                                            var callback2 = {
                                                onNewMin: function(p) {
                                                    // postMessage('newmin')
                                                },
                                                onDone: function(p) {

                                                    // dumy function for long time excution
                                                    for ( var i = 0; i < 300000000; i++ ) {
                                                        var a = a * i;
                                                    }

                                                    document.querySelector('#w-loading').style.visibility = 'hidden';
                                                    drawPath(p);
                                                }
                                            };
                                            annealing.init(opts, opts.width, opts.height, callback2);
                                            annealing.go();
                                        }
                                    }, 10);
                                }
                            })();
                        </script>
                    </section>
                    <section>
                        <h2>Good</h2>
                        <br>
                        <ul>
                            <li><span class='myspan'>UI 와 Business Logic 분리가능</span>
                                <ul>
                                    <li>UI 는 항상 non-blocking 되어야 하는 환경</li>
                                    <li>Heavy Weight Scripts (복잡한 산술계산)</li>
                                    <li>AJAX 의 결과 값이 크고 이에 대한 parsing / filter 에 대한 workload 가 큰경우</li>
                                </ul>
                        </ul>
                    </section>
                    <section>
                        <h2>Limited Access</h2>
                        <br>
                        <ul>
                            <li><span class='myspan'>window, document, console, parent object 에 접근 불가</span>
                            <ul><li><span class='myspan'>공유 자원이 없기 때문에 thread 간 race condition이 발생하지 않음</span></ul>
                            <li><span class='myspan'>Shared Worker 는 Worker 내의 전역변수 공유가능</span>
                        </ul>
                    </section>
                    <section>
                        <h2>Communicate with Workers</h2>
                        <br>
                        <ul>
                            <li><span class='myspan'>MessageEvent</span>
                                <ul>
                                    <li>postMessage API</li>
                                    <li>Supports passing JSON structures</li>
                                    <li>The parent and worker threads have their own separate space</li>
                                </ul>
                        </ul>
                    </section>
                    <section>
                        <h2>Terminating Workers</h2>
                        <br>
                        <ul>
                            <li>Workers are resource-intensive, They are OS-level threads</li>
                            <li>Workers can terminate</li>
                            <ul>
                                <li>Workers can terminate themselves</li>
                                <ul><li>self.close();</li></ul>
                                <li>Parent thread can terminate a worker</li>
                                <ul><li>worker.terminate();</li></ul>
                            </ul>
                        </ul>
                    </section>
                    <section>
                        <h2>Kinds of Worker</h2>
                        <br>
                        <ul>
                            <li><span class='myspan'>DedicatedWorker</span>
                                <ul>
                                    <li>하나의 Worker 가 하나의 Thread 를 가지는 Worker</li>
                                </ul>
                            <li><span class='myspan'>SharedWorker</span>
                                <ul>
                                    <li>하나의 Worker 를 공유하고 통신할 수 있는 Worker</li>
                                    <li>All pages or scripts on the same origin can communicate with a shared worker</li>
                                </ul>
                        </ul>
                    </section>
                    <section>
                        <h2>DedicatedWorker Tutorial</h2>
                        <br>
                        <pre><code data-trim>
// index.html
<script>
var worker = new Worker( 'worker.js' );
worker.onmessage = function ( event ) {
    // TODO::Update UI Logic
};
worker.postMessage( values );

function stop() {
    worker.terminate();
}
</script>
                        </code></pre>
                        <pre><code data-trim>
// worker.js
// importScripts( ‘library1.js’, ‘library2.js’);
onmessage = function ( event ) {
    // TODO:: Bussiness Logic
postMessage( data );
}
                        </code></pre>
                    </section>
                    <section>
                        <h2>SharedWorker Tutorial</h2>
                        <br>
                        <pre><code data-trim>
// index.html
<script>
    var worker = new SharedWorker('sharedWorker.js', 'workerName');
    worker.port.onmessage = function ( event ) {
        console.log( event.data );
    };
    worker.port.postMessage( values );
</script>
                        </code></pre>
                        <pre><code data-trim>
// sharedWorker.js
var globalConnections = 0;
onconnect = function ( event ) {
    var port = event.ports[0];
    globalConnections++;
    port.onmessage = function ( event ) {
        port. postMessage( globalConnections );
        // port.close();
    }
}
                </code></pre>
                        <button onclick="window.open('sharedWorker.html',  '_blank', 'height=200,width=200');">Demo</button>
                    </section>
                    <section>
                        <h2>Debugging SharedWorker</h2>
                        <br>
                        <ul>
                            <li><span class='myspan'>Chrome Dev Tools</span>
                                <ul>
                                    <li>chrome://inspect</li>
                                </ul>
                        </ul>
                        <img src="images/inspect.png">
                    </section>
                    <section>
                        <h2>WebWorker Browser Support</h2>
                        <img src="images/webWorkerSupport.png">
                    </section>
                    <section>
                        <h2>SharedWorker Browser Support</h2>
                        <img src="images/sharedWorkerSupport.png">
                    </section>
                    <section>
                        <h2>Tizen 2.3 Browser Support</h2>
                        <img src="images/tizenSupport.png">
                    </section>
                </section>

                <section>
                    <section>
                        <h1>References</h1>
                        <br>
                        <ul>
                            <li><a href="https://html.spec.whatwg.org/multipage/workers.html">Web Worker Spec</a>
                            <li><a href="https://developer.mozilla.org/en-US/docs/Web/Guide/Performance/Using_web_workers">Mozila Developer NetWork - Using web workers</a>
                            <li><a href="http://ejohn.org/blog/how-javascript-timers-work/">John Resig - How JavaScript Timers Work</a>
                            <li><a href="http://www.slideshare.net/nzakas/high-performance-javascript-capitoljs-2011">CapitolJS 2011 - High Performance JavaScript</a>

                        </ul>

                    </section>
                    <section>
                        <h1>Q&A</h1>
                        <br>
                        <img src="images/good.png">
                    </section>
                    <section>
                        <h1>Thank you!</h1>
                        <br>
                            <span class='myspan'><a href="mailto:leechwin1@gmail.com">changhyun1.lee@samsung.com</a></span>
                    </section>
                </section>

            </div>
        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.min.js"></script>
        <script>
            // Full list of configuration options available here:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,

                theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
                transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

                // Parallax scrolling
                // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
                // parallaxBackgroundSize: '2100px 900px',

                // Optional libraries used to extend on reveal.js
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
                    { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
                ]
            });
        </script>
        <script src="js/main.js"></script>
    </body>
</html>
